name: macOS VNC via ngrok
on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: macos-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      VNC_PASSWORD: mac2026A@
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "$NGROK_AUTHTOKEN" ] && [ -z "$NGROK_AUTH_TOKEN" ]; then
            echo "Missing ngrok token secret (NGROK_AUTHTOKEN or NGROK_AUTH_TOKEN)"
            exit 1
          fi

      - name: Set runner account password (best effort)
        run: |
          if sudo dscl . -passwd /Users/runner "$VNC_PASSWORD"; then
            echo "SYSTEM_PASSWORD_UPDATED=true" >> "$GITHUB_ENV"
            echo "Runner account password updated."
          elif sudo dscl . -passwd /Users/runner runner "$VNC_PASSWORD"; then
            echo "SYSTEM_PASSWORD_UPDATED=true" >> "$GITHUB_ENV"
            echo "Runner account password updated using default old password."
          else
            echo "SYSTEM_PASSWORD_UPDATED=false" >> "$GITHUB_ENV"
            echo "Cannot change runner account password on this macOS image. Continue with VNC legacy password."
          fi

      - name: Enable VNC on macOS runner
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -allowAccessFor -allUsers \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent -privs -all
          sudo launchctl kickstart -k system/com.apple.screensharing || true
          for _ in {1..20}; do
            if sudo lsof -nP -iTCP:5900 -sTCP:LISTEN > /dev/null 2>&1; then
              echo "VNC is listening on port 5900"
              exit 0
            fi
            sleep 1
          done
          echo "VNC service is not listening on port 5900"
          exit 1

      - name: Install and configure ngrok
        run: |
          TOKEN="$NGROK_AUTHTOKEN"
          if [ -z "$TOKEN" ]; then
            TOKEN="$NGROK_AUTH_TOKEN"
          fi
          brew install ngrok/ngrok/ngrok
          ngrok config add-authtoken "$TOKEN"

      - name: Create ngrok tunnel for VNC
        run: |
          ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &
          python3 - <<'PY' >> "$GITHUB_ENV"
          import json
          import sys
          import time
          import urllib.request

          api_url = "http://127.0.0.1:4040/api/tunnels"
          for _ in range(30):
              try:
                  with urllib.request.urlopen(api_url, timeout=2) as response:
                      data = json.load(response)
                  tunnels = data.get("tunnels", [])
                  tcp_tunnel = next((t for t in tunnels if t.get("proto") == "tcp"), None)
                  if tcp_tunnel and tcp_tunnel.get("public_url", "").startswith("tcp://"):
                      host_port = tcp_tunnel["public_url"].replace("tcp://", "", 1)
                      host, port = host_port.rsplit(":", 1)
                      print(f"NGROK_HOST={host}")
                      print(f"NGROK_PORT={port}")
                      sys.exit(0)
              except Exception:
                  pass
              time.sleep(2)
          print("Cannot get ngrok tcp tunnel", file=sys.stderr)
          sys.exit(1)
          PY

      - name: Print RealVNC connection info
        run: |
          MACHINE_USERNAME="$(whoami)"
          SYSTEM_PASSWORD_UPDATED="${SYSTEM_PASSWORD_UPDATED:-false}"
          echo "RealVNC host: $NGROK_HOST"
          echo "RealVNC port: $NGROK_PORT"
          echo "Machine username: $MACHINE_USERNAME"
          echo "RealVNC password: $VNC_PASSWORD"
          echo "System account password updated: $SYSTEM_PASSWORD_UPDATED"
          if [ "$SYSTEM_PASSWORD_UPDATED" = "true" ]; then
            echo "Machine password: $VNC_PASSWORD"
            echo "If viewer asks for username, use: $MACHINE_USERNAME"
            echo "If viewer asks password only, use: $VNC_PASSWORD"
          else
            echo "Machine password is unchanged on this runner image."
            echo "If viewer asks password only, use: $VNC_PASSWORD"
            echo "If viewer asks username and password, try username: $MACHINE_USERNAME and password: $VNC_PASSWORD"
          fi
          {
            echo "## RealVNC via ngrok"
            echo ""
            echo "- Host: \`$NGROK_HOST\`"
            echo "- Port: \`$NGROK_PORT\`"
            echo "- Username: \`$MACHINE_USERNAME\`"
            echo "- VNC legacy password: \`$VNC_PASSWORD\`"
            echo "- System account password updated: \`$SYSTEM_PASSWORD_UPDATED\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Keep Alive
        run: sleep 21600
