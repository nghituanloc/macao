name: macOS VNC (Optimized)
on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: macos-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      # Rút ngắn mật khẩu còn đúng 8 ký tự để tránh lỗi xác thực trên macOS VNC legacy
      VNC_PASSWORD: mac2026A 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "$NGROK_AUTHTOKEN" ]; then
            echo "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          fi

      - name: Enable VNC and Screen Sharing
        run: |
          # Bỏ qua việc đổi mật khẩu user runner trên macos-latest (không cần cho VNC legacy)

          # Cấu hình Remote Management (ARD) và VNC Legacy
          # Sử dụng -vncpw để đặt mật khẩu riêng cho kết nối VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -allowAccessFor -allUsers \
            -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent

          # Ép khởi động dịch vụ Screensharing để xử lý lỗi "Screen control might be disabled"
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          echo "VNC service configured."

      - name: Install ngrok
        run: brew install ngrok/ngrok/ngrok

      - name: Start ngrok
        run: |
          ngrok config add-authtoken "$NGROK_AUTHTOKEN"
          ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &
          sleep 5 # Chờ ngrok khởi tạo

      - name: Get Connection Info
        run: |
          # Lấy địa chỉ từ API local của ngrok
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "ADDRESS=${PUBLIC_URL#tcp://}" >> $GITHUB_ENV
          echo "Kết nối tới: ${PUBLIC_URL#tcp://}"

      - name: Summary
        run: |
          echo "## Thông tin kết nối VNC" >> $GITHUB_STEP_SUMMARY
          echo "- **Địa chỉ:** \`$ADDRESS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Password:** \`$VNC_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** \`runner\`" >> $GITHUB_STEP_SUMMARY
          echo "> Lưu ý: Nếu RealVNC báo lỗi Auth, hãy dùng TightVNC, TigerVNC hoặc Remmina." >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Hướng dẫn dùng TightVNC / TigerVNC / Remmina" >> $GITHUB_STEP_SUMMARY
          echo "- Mở client VNC (TightVNC, TigerVNC hoặc Remmina)." >> $GITHUB_STEP_SUMMARY
          echo "- Trường *Server/Host*: \`$ADDRESS\`" >> $GITHUB_STEP_SUMMARY
          echo "- Khi hỏi *Password*: nhập \`$VNC_PASSWORD\`." >> $GITHUB_STEP_SUMMARY
          echo "- Không nhập username nếu client chỉ hỏi một ô password." >> $GITHUB_STEP_SUMMARY

          # In ra thông tin đăng nhập vào log nếu có địa chỉ
          if [ -n "$ADDRESS" ]; then
            echo "===== Thông tin đăng nhập VNC ====="
            echo "Địa chỉ: $ADDRESS"
            echo "Username: runner"
            echo "Password: $VNC_PASSWORD"
          else
            echo "Không có thông tin địa chỉ VNC (ngrok có thể chưa khởi tạo thành công)."
          fi

      - name: Keep Alive
        run: sleep 21600