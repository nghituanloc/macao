name: macOS VNC via ngrok (Optimized)
on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: macos-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      # Rút ngắn mật khẩu còn đúng 8 ký tự để tránh lỗi xác thực trên macOS VNC legacy
      VNC_PASSWORD: mac2026A 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "$NGROK_AUTHTOKEN" ]; then
            echo "Error: NGROK_AUTHTOKEN is missing in Secrets"
            exit 1
          fi

      - name: Enable VNC and Screen Sharing
        run: |
          # Thiết lập mật khẩu cho user runner để đăng nhập hệ thống
          sudo dscl . -passwd /Users/runner "$VNC_PASSWORD" || echo "Không thể đổi pass user, bỏ qua..."
          
          # Cấu hình Remote Management (ARD) và VNC Legacy
          # Sử dụng -vncpw để đặt mật khẩu riêng cho kết nối VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -allowAccessFor -allUsers \
            -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent

          # Ép khởi động dịch vụ Screensharing để xử lý lỗi "Screen control might be disabled"
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          echo "VNC service configured."

      - name: Install ngrok
        run: brew install ngrok/ngrok/ngrok

      - name: Start ngrok
        run: |
          ngrok config add-authtoken "$NGROK_AUTHTOKEN"
          ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &
          sleep 5 # Chờ ngrok khởi tạo

      - name: Get Connection Info
        run: |
          # Lấy địa chỉ từ API local của ngrok
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "ADDRESS=${PUBLIC_URL#tcp://}" >> $GITHUB_ENV
          echo "Kết nối tới: ${PUBLIC_URL#tcp://}"

      - name: Summary
        run: |
          echo "## Thông tin kết nối VNC" >> $GITHUB_STEP_SUMMARY
          echo "- **Địa chỉ:** \`$ADDRESS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Password:** \`$VNC_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** \`runner\`" >> $GITHUB_STEP_SUMMARY
          echo "> Lưu ý: Nếu RealVNC báo lỗi Auth, hãy thử dùng trình duyệt hoặc phần mềm VNC khác như TightVNC." >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: sleep 21600