name: macOS VNC via ngrok (Optimized)
on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: macos-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      VNC_PASSWORD: mac2026A
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "$NGROK_AUTHTOKEN" ] && [ -z "$NGROK_AUTH_TOKEN" ]; then
            echo "Error: missing NGROK_AUTHTOKEN or NGROK_AUTH_TOKEN secret"
            exit 1
          fi

      - name: Enable VNC and Screen Sharing
        run: |
          # Best effort: try to align runner account password.
          if sudo dscl . -passwd /Users/runner "$VNC_PASSWORD"; then
            echo "SYSTEM_PASSWORD_UPDATED=true" >> "$GITHUB_ENV"
          else
            echo "SYSTEM_PASSWORD_UPDATED=false" >> "$GITHUB_ENV"
            echo "Cannot change runner account password, continue."
          fi

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -allowAccessFor -allUsers \
            -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent

          sudo launchctl kickstart -k system/com.apple.screensharing || true

          for _ in {1..20}; do
            if sudo lsof -nP -iTCP:5900 -sTCP:LISTEN > /dev/null 2>&1; then
              echo "VNC service ready on port 5900"
              exit 0
            fi
            sleep 1
          done
          echo "Error: VNC service not listening on port 5900"
          exit 1

      - name: Install ngrok
        run: brew install ngrok/ngrok/ngrok

      - name: Start ngrok
        run: |
          TOKEN="$NGROK_AUTHTOKEN"
          if [ -z "$TOKEN" ]; then
            TOKEN="$NGROK_AUTH_TOKEN"
          fi
          ngrok config add-authtoken "$TOKEN"
          ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &

      - name: Get connection info
        run: |
          python3 - <<'PY' >> "$GITHUB_ENV"
          import json
          import sys
          import time
          import urllib.request

          api_url = "http://127.0.0.1:4040/api/tunnels"
          for _ in range(30):
              try:
                  with urllib.request.urlopen(api_url, timeout=2) as response:
                      data = json.load(response)
                  tunnels = data.get("tunnels", [])
                  tcp_tunnel = next((t for t in tunnels if t.get("proto") == "tcp"), None)
                  if tcp_tunnel and tcp_tunnel.get("public_url", "").startswith("tcp://"):
                      address = tcp_tunnel["public_url"].replace("tcp://", "", 1)
                      host, port = address.rsplit(":", 1)
                      print(f"ADDRESS={address}")
                      print(f"NGROK_HOST={host}")
                      print(f"NGROK_PORT={port}")
                      sys.exit(0)
              except Exception:
                  pass
              time.sleep(2)
          print("Error: cannot get ngrok tunnel from local API", file=sys.stderr)
          sys.exit(1)
          PY
          echo "Connect to: $ADDRESS"

      - name: Summary
        run: |
          MACHINE_USERNAME="$(whoami)"
          SYSTEM_PASSWORD_UPDATED="${SYSTEM_PASSWORD_UPDATED:-false}"
          echo "VNC address: $ADDRESS"
          echo "VNC username: $MACHINE_USERNAME"
          echo "VNC password: $VNC_PASSWORD"
          echo "System password updated: $SYSTEM_PASSWORD_UPDATED"
          {
            echo "## VNC connection info"
            echo ""
            echo "- Address: \`$ADDRESS\`"
            echo "- Username: \`$MACHINE_USERNAME\`"
            echo "- Password: \`$VNC_PASSWORD\`"
            echo "- System account password updated: \`$SYSTEM_PASSWORD_UPDATED\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Keep Alive
        run: sleep 21600
