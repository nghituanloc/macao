name: macOS GUI via Ngrok
on:
  workflow_dispatch:

jobs:
  gui:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ngrok
        run: brew install --cask ngrok

      - name: Authenticate Ngrok
        run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Create Admin User & Enable Screen Sharing
        run: |
          # 1. Tạo user mới
          sudo dscl . -create /Users/adminuser
          sudo dscl . -create /Users/adminuser UserShell /bin/zsh
          sudo dscl . -create /Users/adminuser RealName "Admin User"
          sudo dscl . -create /Users/adminuser UniqueID 503
          sudo dscl . -create /Users/adminuser PrimaryGroupID 20
          sudo dscl . -passwd /Users/adminuser 123456
          sudo dscl . -append /Groups/admin GroupMembership adminuser
          sudo createhomedir -c -u adminuser > /dev/null

          # 2. Cấu hình Tự động đăng nhập (Auto Login) để tránh màn hình đen
          # (Lưu ý: Đoạn này dùng script python để tạo file mã hóa mật khẩu)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser adminuser
          sudo python3 -c '
          import os
          # Mật khẩu 123456 được mã hóa XOR cho file kcpassword
          kc_hex = "7D 89 78 80 7D 89 78 80 7D 89 78 80"
          with open("/etc/kcpassword", "wb") as f:
              f.write(bytes.fromhex(kc_hex))
          os.chmod("/etc/kcpassword", 0o600)
          '
          
          # 3. Kích hoạt Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users adminuser \
          -privs -all -restart -agent -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw 123456

      - name: Setup tmate session (backup)
        uses: mxschmitt/action-tmate@v2

      - name: Start Ngrok Tunnel
        run: |
          ngrok tcp 5900 &
          sleep 10
          echo "Dia chi truy cap VNC:"
          curl --silent http://127.0.0.1:4040/api/tunnels | python3 -c "import json,sys; data=json.load(sys.stdin); print(data['tunnels'][0]['public_url'])"

      - name: Keep Alive
        run: sleep 21600