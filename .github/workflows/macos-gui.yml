name: macOS GUI via Ngrok
on:
  workflow_dispatch:

jobs:
  gui:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ngrok
        run: brew install --cask ngrok

      - name: Authenticate Ngrok
        run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable Screen Sharing & Set Password
        run: |
          # 1. Đặt mật khẩu hệ thống cho user 'runner' là 123456 (Quan trọng nhất)
          sudo dscl . -passwd /Users/runner 123456
          
          # 2. Kích hoạt Screen Sharing cho phép đăng nhập bằng user/pass
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -restart -agent -privs -all

      - name: Start Ngrok Tunnel
        run: |
          ngrok tcp 5900 &
          sleep 10
          echo "Dia chi truy cap VNC:"
          curl --silent http://127.0.0.1:4040/api/tunnels | python3 -c "import json,sys; data=json.load(sys.stdin); print(data['tunnels'][0]['public_url'])"

      - name: Keep Alive
        run: sleep 21600